<html>
<head>
  <script type="text/javascript" src="webrtc_test_utilities.js"></script>
  <script type="text/javascript">
  $ = function(id) {
    return document.getElementById(id);
  };

  var gLocalStream = null;

  setAllEventsOccuredHandler(function() {
    gLocalStream.stop();
    document.title = 'OK';
    sendValueToTest(document.title);
  });

  function sendValueToTest(value) {
    window.domAutomationController.setAutomationId(0);
    window.domAutomationController.send(value);
  }

  function getSources() {
    MediaStreamTrack.getSources(function(devices) {
      document.title = 'Sources Available';
      sendValueToTest(JSON.stringify(devices));
    });
  }

  // Creates a MediaStream and renders it locally. When the video is detected to
  // be rolling, the title is changed and the stream should be stopped.
  function getUserMediaAndStop(constraints) {
    document.title = 'Calling GetUserMedia';
    navigator.webkitGetUserMedia(
        constraints,
        function(stream) { displayAndDetectVideo(stream, stopVideoTrack); },
        failedCallback);
  }

  // Creates a MediaStream and renders it locally. When the video is detected to
  // be rolling, the title should be changed and the stream is let roll for a
  // number |waitTimeInSeconds| and then it should be stopped.
  function getUserMediaAndWaitAndStop(constraints, waitTimeInSeconds) {
    navigator.webkitGetUserMedia(
        constraints,
        function(stream) {
          displayAndDetectVideo(
            stream,
            function() {
              waitAndStopVideoTrack(waitTimeInSeconds);
            });
        },
        failedCallback);
  }

  function getUserMediaAndAnalyseAndStop(constraints) {
    navigator.webkitGetUserMedia(
        constraints, displayDetectAndAnalyzeVideo, failedCallback);
  }

  // This test that a MediaStream can be cloned and that the clone can
  // be rendered.
  function getUserMediaAndClone() {
    navigator.webkitGetUserMedia({video: true, audio: true},
        createAndRenderClone, failedCallback);
  }

  // Creates two MediaStream and renders them locally. When the video of both
  // streams are detected to be rolling, we stop the local stream. Since both
  // streams have the same source, both video streams should stop. If they do,
  // the test succeeds.
  function twoGetUserMediaAndStop(constraints) {
    document.title = 'Calling Two GetUserMedia';
    navigator.webkitGetUserMedia(
        constraints,
        function(stream) { 
          displayAndDetectVideo(stream, requestSecondGetUserMedia); 
        },
        failedCallback);
    var requestSecondGetUserMedia = function() {
      navigator.webkitGetUserMedia(
          constraints,
          function(stream) { 
            displayIntoVideoElement(stream, 
                stopStreamAndVerifyAllLocalViewsDontPlayVideo, 'local-view-2');
          },
          failedCallback);
    };
    
    var stopStreamAndVerifyAllLocalViewsDontPlayVideo = function() {
      gLocalStream.getVideoTracks()[0].stop();
      
      // Since local-view and local-view-2 are playing the video from the same
      // source, both of them should stop.
      waitForVideoToStop('local-view');
      waitForVideoToStop('local-view-2');
    };   
  }

  function failedCallback(error) {
    document.title = 'GetUserMedia call failed with code ' + error.code;
    sendValueToTest(document.title);
  }

  function plugStreamIntoVideoElement(stream, videoElement) {
    gLocalStream = stream;
    var localStreamUrl = URL.createObjectURL(stream);
    $(videoElement).src = localStreamUrl;
  }

  function displayIntoVideoElement(stream, callback, videoElement) {
    plugStreamIntoVideoElement(stream, videoElement);
    document.title = 'Waiting for video...';
    detectVideoPlaying(videoElement, callback);
  }

  function displayAndDetectVideo(stream, callback) {
    displayIntoVideoElement(stream, callback, 'local-view');
  }

  function displayDetectAndAnalyzeVideo(stream) {
    plugStreamIntoVideoElement(stream, 'local-view');
    analyzeVideo();
  }

  function createAndRenderClone(stream) {
    gLocalStream = stream;
    // TODO(perkj):  --use-fake-device-for-media-stream do not currently
    // work with audio devices and not all bots has a microphone.
    new_stream = new webkitMediaStream();
    new_stream.addTrack(stream.getVideoTracks()[0]);
    expectEquals(new_stream.getVideoTracks().length, 1);
    if (stream.getAudioTracks().length > 0) {
      new_stream.addTrack(stream.getAudioTracks()[0]);
      expectEquals(new_stream.getAudioTracks().length, 1);
      new_stream.removeTrack(new_stream.getAudioTracks()[0]);
      expectEquals(new_stream.getAudioTracks().length, 0);
    }

    var newStreamUrl = URL.createObjectURL(new_stream);
    $('local-view').src = newStreamUrl;
    waitForVideo('local-view');
  }

  function stopVideoTrack() {
    gLocalStream.getVideoTracks()[0].stop();
    waitForVideoToStop('local-view');
  }

  function waitAndStopVideoTrack(waitTimeInSeconds) {
    document.title = 'Running...';
    setTimeout(stopVideoTrack, waitTimeInSeconds * 1000);
  }

  function analyzeVideo() {
    document.title = 'Waiting for video...';
    addExpectedEvent();
    detectAspectRatio(function(aspectRatio) {
      document.title = aspectRatio;
      eventOccured();
    });
  }

  </script>
</head>
<body>
  <table border="0">
    <tr>
      <td>Local Preview</td>
    </tr>
    <tr>
      <td><video width="320" height="240" id="local-view"
          autoplay="autoplay"></video></td>
      <td><canvas width="320" height="240" id="local-view-canvas"
          style="display:none"></canvas></td>
    </tr>
    <tr>
      <td>Local Preview 2</td>
    </tr>
    <tr>
      <td><video width="320" height="240" id="local-view-2"
          autoplay="autoplay"></video></td>
      <!-- Canvases are named after their corresponding video elements. -->
      <td><canvas width="320" height="240" id="local-view-2-canvas"
          style="display:none"></canvas></td>
    </tr>
  </table>
</body>
</html>
